// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("STAFF") // ADMIN, STAFF, MANAGER, DRIVER, OPERATION_MANAGER, MD, CEO, ACCOUNTANT
  workId    String?  @unique // Employee ID
  phoneNumber String?
  image     String?  // Base64 or URL
  isDisabled Boolean  @default(false)
  lastActive DateTime? // Track online status
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trips     Trip[]
  
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  documents        Document[]
  createdFolders   DocumentFolder[]

  @@index([role])
  @@index([email])
  @@map("User")
}

model DocumentFolder {
  id        String     @id @default(uuid())
  name      String     @unique
  creatorId String
  creator   User       @relation(fields: [creatorId], references: [id])
  createdAt DateTime   @default(now())
  isLocked  Boolean    @default(false)
  documents Document[]

  @@map("DocumentFolder")
}

model Message {
  id            String    @id @default(uuid())
  senderId      String
  sender        User      @relation("SentMessages", fields: [senderId], references: [id])
  receiverId    String
  receiver      User      @relation("ReceivedMessages", fields: [receiverId], references: [id])
  content       String?
  attachment    String?   // Base64 string for low-size storage
  attachmentType String?  // 'IMAGE'
  isRead        Boolean   @default(false)
  createdAt     DateTime  @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@map("Message")
}

model Document {
  id         String   @id @default(uuid())
  name       String
  data       String
  mimeType   String
  uploaderId String
  uploader   User     @relation(fields: [uploaderId], references: [id])
  folderId   String?
  folder     DocumentFolder? @relation(fields: [folderId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([folderId])
  @@index([uploaderId])
  @@map("Document")
}

model Shipment {
  id             String           @id @default(uuid())
  waybillNumber  String           @unique // e.g., KPL-8829
  
  // Sender Details
  senderName     String
  senderEmail    String?
  senderPhone    String
  senderAddress  String?
  
  // Receiver Details
  receiverName   String
  receiverPhone  String
  receiverAddress String?
  
  // Shipment Details
  origin         String
  destination    String
  weight         Float?
  price          Float?
  cargoDetails   String?
  
  currentStatus  String   @default("PENDING")
  dispatcherName String?
  dispatcherSignature String? // Stores workId
  receiverSignature String? // Base64 signature
  receivedBy     String?  // Name of the person who actually received it
  
  events         TrackingEvent[]
  trips          Trip[]
  vehicleTracking VehicleTracking?
  
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([currentStatus])
  @@index([senderPhone])
  @@index([receiverPhone])
  @@index([createdAt])
  @@map("Shipment")
}

model Trip {
  id            String    @id @default(uuid())
  driverId      String
  driver        User      @relation(fields: [driverId], references: [id])
  shipmentId    String?
  shipment      Shipment? @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  startLocation String
  endLocation   String
  startTime     DateTime  @default(now())
  endTime       DateTime?
  status        String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED

  checkIns      CheckIn[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([driverId])
  @@index([status])
  @@index([startTime])
  @@map("Trip")
}

model CheckIn {
  id        String   @id @default(uuid())
  tripId    String
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  
  location  String   // Text description
  latitude  Float
  longitude Float
  status    String   // OK, BREAKDOWN, RESTING
  
  timestamp DateTime @default(now())

  @@index([tripId])
  @@map("CheckIn")
}

model TrackingEvent {
  id          String         @id @default(uuid())
  shipmentId  String
  shipment    Shipment       @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  status      String
  location    String         // e.g., "Dar es Salaam Hub"
  remarks     String?        // e.g., "Dispatched to Mwanza Branch"
  
  timestamp   DateTime       @default(now())

  @@index([shipmentId])
  @@index([timestamp])
  @@map("TrackingEvent")
}

model PickupRequest {
  id              String   @id @default(uuid())
  senderName      String
  senderPhone     String
  pickupAddress   String
  destination     String
  cargoDetails    String
  estimatedWeight String?
  status          String   @default("PENDING") // PENDING, ISSUED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("PickupRequest")
}

model ServiceShowcase {
  id          String   @id @default(uuid())
  title       String
  description String
  imageUrl    String
  icon        String   // e.g., 'Truck', 'Ship', 'Plane', 'Package'
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([sortOrder])
  @@map("ServiceShowcase")
}

model Executive {
  id          String   @id @default(uuid())
  name        String
  role        String
  bio         String
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("Executive")
}

model VehicleTracking {
  id                String   @id @default(uuid())
  shipmentId        String   @unique
  shipment          Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  // Route definition (JSON array of [lat, lng] coordinates)
  routePath         Json     // [[lat, lng], [lat, lng], ...]
  
  // Current position and progress
  currentLatitude   Float
  currentLongitude  Float
  routeIndex        Int      @default(0)  // Current position index in route array
  distanceCompleted Float    @default(0)  // Total distance traveled in meters
  totalDistance     Float    @default(0)  // Total route distance in meters
  progressPercent  Float    @default(0)  // Progress percentage (0-100)
  
  // Movement simulation data
  currentSpeed      Float    @default(40) // Current speed in km/h
  isCityZone        Boolean  @default(true) // Whether currently in city zone
  lastUpdateTime    DateTime @default(now()) // Last position update timestamp
  
  // Status and control
  isActive          Boolean  @default(true)
  isPaused          Boolean  @default(false)
  simulationStart   DateTime @default(now()) // When simulation started
  
  routeSegments     RouteSegment[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([shipmentId])
  @@index([isActive])
  @@index([lastUpdateTime])
  @@map("VehicleTracking")
}

model RouteSegment {
  id          String   @id @default(uuid())
  trackingId  String
  tracking    VehicleTracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)
  
  startLat    Float
  startLng    Float
  endLat      Float
  endLng      Float
  distance    Float    // Distance in meters
  isCityZone  Boolean  @default(false) // Whether this segment is in city zone
  speedLimit  Float    @default(40) // Speed limit for this segment (km/h)
  
  orderIndex  Int      // Order in the route
  
  createdAt   DateTime @default(now())

  @@index([trackingId])
  @@map("RouteSegment")
}
